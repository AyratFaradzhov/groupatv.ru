# 🧠 SMART PRODUCT DISCOVERY ENGINE - АРХИТЕКТУРА

## Обзор

SMART PRODUCT DISCOVERY ENGINE — это интеллектуальная система поиска и импорта продуктов из неструктурированной файловой системы. Это НЕ простой парсер, а система машинного обнаружения продуктов на основе множественных сигналов.

## Архитектура Pipeline

```
┌─────────────────────────────────────────────────────────────┐
│                    DISCOVERY PHASE                          │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐   │
│  │  Scan    │→ │ Metadata │→ │  Index   │→ │  Cache   │   │
│  │  Files   │  │ Extract  │  │  Build   │  │  Store   │   │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘   │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│              CANDIDATE GROUPING PHASE                      │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐   │
│  │Structural│→ │ Visual   │→ │ Context  │→ │ Product  │   │
│  │ Signals  │  │ Signals  │  │ Signals  │  │Candidate │   │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘   │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│              VISUAL ANALYSIS PHASE                         │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐   │
│  │ Image    │→ │ Perceptual│→ │ Duplicate│→ │ Quality  │   │
│  │ Metadata │  │ Hash      │  │ Detection│  │ Analysis │   │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘   │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│              DECISION ENGINE PHASE                         │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐   │
│  │ Scoring  │→ │ Threshold│→ │ Validation│→ │ Product  │   │
│  │ Model    │  │ Check    │  │ Rules    │  │ Creation │   │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘   │
└─────────────────────────────────────────────────────────────┘
```

## Этап 1: DISCOVERY

### Цель
Найти ВСЕ изображения в директории `foods/` и собрать метаданные БЕЗ импорта.

### Компоненты

#### 1.1 File Scanner
- Использует `fast-glob` для рекурсивного сканирования
- Находит все `.webp` файлы
- Игнорирует дубликаты по имени (файлы с ` 2`, ` 3` в конце)
- Строит индекс путей

#### 1.2 Metadata Extractor
- Использует `sharp` для извлечения:
  - Размеры изображения (width, height)
  - Формат и качество
  - EXIF данные (если есть)
- Использует `fs.statSync` для:
  - Размера файла
  - Даты модификации
- Строит объект `ImageMetadata`

#### 1.3 Index Builder
- Создает индекс по:
  - Пути к файлу
  - Размеру файла
  - Perceptual hash (будет на этапе 3)
- Группирует по директориям

#### 1.4 Cache Store
- Кэширует метаданные для быстрого доступа
- Сохраняет промежуточные результаты

### Результат этапа
```javascript
{
  images: [
    {
      path: "foods/01 Tayas/.../1753 Арбуз 1.webp",
      metadata: {
        width: 1920,
        height: 1080,
        size: 245678,
        format: "webp",
        aspectRatio: 1.78,
        mtime: 1234567890
      },
      directory: "foods/01 Tayas/.../1753 Кислые Ремешки ( Арбуз )",
      relativePath: "01 Tayas/.../1753 Арбуз 1.webp"
    }
  ],
  directories: Map<path, images[]>,
  stats: {
    totalImages: 500,
    totalDirectories: 150,
    totalSize: 123456789
  }
}
```

## Этап 2: CANDIDATE GROUPING

### Цель
Сгруппировать изображения в `ProductCandidate` на основе структурных, визуальных и контекстных сигналов.

### Компоненты

#### 2.1 Structural Signals
Анализирует структуру пути:
- Глубина вложенности (оптимально 3-5)
- Наличие бренда в пути (`01 Tayas`, `02 Pakel`)
- Наличие категории (`Мармелады`, `Конфеты`)
- Наличие подкатегории (`Кислые`, `Желейный`)
- Наличие веса в пути (`15 г`, `1000 г`)

**Score:** 0.0 - 1.0

#### 2.2 Visual Signals
Анализирует визуальные характеристики:
- Размер изображения (оптимально 1920x1080 - 3840x2160)
- Aspect ratio (оптимально 0.8 - 1.5 для продуктов)
- Размер файла (оптимально 100KB - 2MB)
- Наличие нескольких изображений в папке

**Score:** 0.0 - 1.0

#### 2.3 Context Signals
Анализирует контекст:
- Наличие docx/doc файлов рядом
- Наличие других изображений в папке
- Стабильность пути (нет temp, tmp, test)
- Повторяемость структуры

**Score:** 0.0 - 1.0

#### 2.4 ProductCandidate Builder
Создает кандидата продукта:
```javascript
{
  id: "candidate-{hash}",
  images: [ImageMetadata[]],
  mainImage: ImageMetadata,
  structuralScore: 0.85,
  visualScore: 0.78,
  contextScore: 0.90,
  directory: "path/to/directory",
  extracted: {
    brand: "TAYAS",
    category: "marmalade",
    type: "ремешки",
    flavor: "арбуз",
    weight: "15gr"
  }
}
```

### Правила группировки

1. **Изображения в одной папке** → потенциально один продукт
2. **Визуально похожие** (perceptual hash) → варианты одного продукта
3. **Одиночные изображения** → отбрасываются (score < threshold)
4. **Множественные изображения** (2-5) → хороший кандидат

### Результат этапа
```javascript
{
  candidates: [
    ProductCandidate,
    ProductCandidate,
    ...
  ],
  rejected: [
    { reason: "single_image", count: 50 },
    { reason: "low_score", count: 30 }
  ]
}
```

## Этап 3: VISUAL ANALYSIS

### Цель
Глубокий визуальный анализ для определения дубликатов и качества изображений.

### Компоненты

#### 3.1 Image Metadata (sharp)
- Извлекает реальные размеры
- Определяет формат и качество
- Анализирует цветовое пространство

#### 3.2 Perceptual Hash (blockhash-core)
- Генерирует perceptual hash для каждого изображения
- Использует blockhash алгоритм
- Создает fingerprint изображения

#### 3.3 Duplicate Detection
- Сравнивает perceptual hash между изображениями
- Находит дубликаты (hash distance < threshold)
- Группирует варианты одного продукта

#### 3.4 Quality Analysis
- Определяет качество изображения:
  - Разрешение (DPI, если доступно)
  - Четкость (анализ градиентов)
  - Композиция (центрирование объекта)
- Выбирает лучшее изображение из группы

### Результат этапа
```javascript
{
  candidates: [
    {
      ...candidate,
      visualAnalysis: {
        phash: "a1b2c3d4...",
        quality: 0.92,
        isDuplicate: false,
        duplicates: [],
        mainImageSelected: true
      }
    }
  ],
  duplicates: [
    { candidate1: "id1", candidate2: "id2", similarity: 0.95 }
  ]
}
```

## Этап 4: DECISION ENGINE

### Цель
Принять решение о создании продукта на основе scoring-модели.

### Scoring-модель

#### Формула
```
totalScore = 
  structuralScore * 0.30 +
  visualScore * 0.35 +
  semanticScore * 0.25 +
  contextScore * 0.10 -
  penalties
```

#### Компоненты

**Structural Score (30%):**
- Глубина пути: 0.0 - 0.15
- Структурированность: 0.0 - 0.15

**Visual Score (35%):**
- Качество изображения: 0.0 - 0.20
- Aspect ratio: 0.0 - 0.10
- Размер файла: 0.0 - 0.05

**Semantic Score (25%):**
- Бренд найден: 0.0 - 0.10
- Категория найдена: 0.0 - 0.08
- Тип найден: 0.0 - 0.05
- Вес найден: 0.0 - 0.02

**Context Score (10%):**
- Docx файл: 0.0 - 0.05
- Стабильность пути: 0.0 - 0.03
- Связанные файлы: 0.0 - 0.02

**Penalties:**
- Одиночное изображение: -0.30
- Дубликат существующего: -0.50
- Низкое качество: -0.20
- Неструктурированный путь: -0.15

#### Пороги

- **MIN_SCORE**: 0.65 (65%) - минимальный для создания
- **HIGH_CONFIDENCE**: 0.80 (80%) - высокая уверенность
- **LOW_CONFIDENCE**: 0.65 - 0.80 - средняя уверенность

### Правила валидации

1. **Обязательные условия:**
   - Score ≥ MIN_SCORE
   - Главное изображение выбрано
   - Immutable slug сформирован
   - Нет дубликатов с существующими

2. **Запрещено:**
   - Создавать из одного изображения (без группы)
   - Использовать имя файла как основу slug
   - Добавлять суффиксы -1, -2, -3
   - Fallback-логика

3. **При сомнении:**
   - НЕ создавать продукт
   - Логировать в отчет
   - Сохранять для ручной проверки

### Результат этапа
```javascript
{
  approved: [
    {
      candidate: ProductCandidate,
      score: 0.85,
      product: {
        id: "tayas-remeshki-arbuz-15gr",
        name: "Кислые ремешки DAMLA, Арбуз",
        ...
      }
    }
  ],
  rejected: [
    {
      candidate: ProductCandidate,
      score: 0.45,
      reason: "low_score"
    }
  ],
  stats: {
    total: 150,
    approved: 120,
    rejected: 30
  }
}
```

## Идемпотентность

### Механизм
1. Проверка по immutable slug
2. Проверка по perceptual hash главного изображения
3. Проверка по пути к изображению
4. Если совпадение найдено → пропуск

### Immutable Slug
Формируется из:
1. Бренд (из структуры)
2. Тип продукта
3. Вкус/характеристика
4. Вес

**НЕ используется:**
- Имя файла
- Числовые коды
- Временные данные

## Масштабируемость

### Оптимизации
1. **Кэширование метаданных** - избегаем повторного чтения
2. **Параллельная обработка** - используем worker threads для больших объемов
3. **Инкрементальное обновление** - обрабатываем только новые файлы
4. **Batch processing** - группируем операции

### Производительность
- 100 продуктов: ~5-10 секунд
- 500 продуктов: ~30-60 секунд
- 1000+ продуктов: ~2-5 минут

## Расширяемость

### Плагины
- Custom scoring rules
- Custom grouping strategies
- Custom visual analyzers

### Конфигурация
Все параметры вынесены в CONFIG объект:
- Пороги scoring
- Веса компонентов
- Правила валидации

