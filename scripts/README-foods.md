# Скрипт сканирования foods/

## Описание

Скрипт `scan-foods.js` автоматически сканирует папку `foods/` рекурсивно, находит все `.webp` файлы, группирует их по продуктам и копирует в структуру `assets/images/products/`.

## Требования

- Node.js (версия 12 или выше)
- Только встроенные модули Node.js (fs, path) - дополнительные пакеты не требуются

## Запуск

### Самый простой способ (Windows)
Просто дважды кликните на файл `scripts/run-scan.bat` - скрипт запустится автоматически.

### Windows (PowerShell)
```powershell
cd "C:\Users\Galax\OneDrive\Рабочий стол\Atv_gro"
node scripts\scan-foods.js
```

### Windows (CMD)
```cmd
cd "C:\Users\Galax\OneDrive\Рабочий стол\Atv_gro"
node scripts\scan-foods.js
```

### Альтернативный способ (если проблемы с путями)
```powershell
# Перейти в корень проекта
Set-Location -LiteralPath 'C:\Users\Galax\OneDrive\Рабочий стол\Atv_gro'
# Запустить скрипт
node .\scripts\scan-foods.js
```

## Что делает скрипт

1. **Сканирует** папку `foods/` рекурсивно
2. **Находит** все `.webp` файлы (игнорирует `.jpg`, `.png`)
3. **Определяет** для каждого файла:
   - Бренд (из структуры папок: `01 Tayas` → `TAYAS`)
   - Категорию (Мармелады, Конфеты, Шоколады и т.д.)
   - Вес (15г, 90gr, 1000г и т.д.)
   - Название продукта (из пути и имени файла)
4. **Группирует** файлы по продуктам (один продукт = несколько изображений)
5. **Копирует** файлы в структуру:
   - `assets/images/products/<Product Folder>/<Product Folder>.webp` (главное изображение)
   - `assets/images/products/<Product Folder>/extra/` (дополнительные изображения)
6. **Создает** отчет `scripts/foods-scan-report.json` со всеми найденными файлами

## Структура отчета

Отчет содержит массив объектов:
```json
[
  {
    "sourcePath": "полный путь к исходному файлу",
    "brandGuess": "TAYAS",
    "categoryGuess": "Мармелады",
    "weightGuess": "15gr",
    "productNameGuess": "ремешки клубника",
    "suggestedId": "tayas-remeshki-klubnika-15gr",
    "suggestedTargetDir": "путь к целевой папке",
    "suggestedTargetImage": "путь к главному изображению",
    "extraImages": [
      {
        "sourcePath": "...",
        "targetPath": "...",
        "filename": "..."
      }
    ]
  }
]
```

## Правила формирования ID

- Формат: `{brandSlug}-{nameSlug}-{weightSlug}`
- Только латиница, цифры и дефисы
- Все в нижнем регистре
- Примеры:
  - `damla-bears-80gr`
  - `jimmy-belts-75gr`
  - `tayas-remeshki-klubnika-15gr`

## Правила выбора главного изображения

1. Файл с "main" в имени
2. Файл с "1" в конце имени (например, `product 1.webp`)
3. Файл без цифр в конце (короткое имя)
4. Иначе - самый короткий по имени

## Важно

- **Исходные файлы в `foods/` НЕ удаляются** - скрипт только копирует
- Если для одного продукта найдено несколько `.webp`:
  - Один становится главным (в корне папки продукта)
  - Остальные копируются в `extra/`
- Скрипт создает необходимые папки автоматически

## Результат выполнения

После выполнения скрипт выводит:
```
=== ИТОГИ ===
Найдено webp файлов: XXX
Создано товаров: XXX
Дополнительных изображений: XXX
Отчет сохранен: scripts/foods-scan-report.json
```

---

## Синхронизация products.json

После сканирования foods/ и создания ассетов, нужно синхронизировать `data/products.json` с новыми файлами.

### Запуск синхронизации

```powershell
node scripts\sync-products-json.js
```

Или через батник (если создан):
```cmd
scripts\sync-products-json.bat
```

### Что делает скрипт синхронизации

1. **Создает backup** `data/products.backup.json` перед изменениями
2. **Проверяет существующие товары**:
   - Проверяет существование файлов изображений
   - Если файл не найден — пытается найти соответствие в отчете и обновить путь
   - Добавляет новые поля: `weight`, `flavors`, `type` (если их нет)
3. **Добавляет новые товары** из отчета:
   - Создает новые записи для товаров, которых нет в JSON
   - Автоматически определяет категорию (создает новую, если нужно)
   - Заполняет все необходимые поля
   - Генерирует теги на основе категории, бренда, вкуса, типа
4. **Обновляет бренды**:
   - Добавляет новые бренды, если они найдены в товарах
   - Проверяет существование логотипов (выводит предупреждения, если не найдены)
5. **Валидирует результат**:
   - Проверяет, что JSON валиден
   - Проверяет существование всех изображений
   - Выводит отчет о проделанной работе

### Новые поля в products.json

Скрипт добавляет следующие поля (если их нет):

- **`weight`** (строка): вес продукта, например `"15gr"`, `"80gr"`, `"1000gr"`
- **`flavors`** (массив строк): вкусы продукта, например `["клубника", "strawberry"]`
- **`type`** (строка): тип продукта, например `"belts"`, `"pencils"`, `"bears"`, `"tubes"`

Эти поля используются для улучшенной фильтрации и поиска.

### Результат выполнения

После выполнения скрипт выводит:
```
=== ИТОГИ ===
Исправлено путей: XXX
Добавлено товаров: XXX
Отсутствующих файлов: XXX

Примеры добавленных товаров:
1. Карандаши Кола (tayas-karandashi-kola-1000gr)
   Бренд: TAYAS, Категория: marmalade
   Изображение: assets/images/products/karandashi-kola-1000gr/karandashi-kola-1000gr.webp
   Вес: 1000gr
   Вкусы: кола, cola
   Тип: pencils
```

### Важно

- **Backup создается автоматически** перед любыми изменениями
- **Существующие ID не меняются** — скрипт только добавляет новые товары
- **Если товар уже существует** — обновляются только пути к изображениям и добавляются новые поля
- **Категории создаются автоматически**, если их нет в `categories{}`
- **Бренды добавляются автоматически**, если их нет в `brands[]`

### Полный процесс работы с foods/

1. **Сканирование**: `node scripts\scan-foods.js`
   - Сканирует `foods/` и создает ассеты в `assets/images/products/`
   - Создает отчет `scripts/foods-scan-report.json`

2. **Синхронизация**: `node scripts\sync-products-json.js`
   - Обновляет `data/products.json` на основе отчета
   - Исправляет пути к изображениям
   - Добавляет новые товары
   - Создает backup перед изменениями

